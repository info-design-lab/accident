<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<title>Sankey Diagram for year 2002</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed" rel="stylesheet">
</head>
<style>

body{
	font: 14px 'Roboto Condensed', 'Helvetica', 'Arial', sans-serif;
	font-weight: normal;
	text-align: center;
}
text{
	font-size:12px;
}
.mainBars rect{
  shape-rendering: auto;
  fill-opacity: 0;
  stroke-width: 1.5px;
  stroke: rgb(0, 0, 0);
  stroke-opacity: 0;
}
.subBars{
	shape-rendering:crispEdges;
}
.edges{
	stroke:none;
	fill-opacity:0.5;
}
.header{
	text-anchor:middle;
	font-size:16px;
	text-align: center;
}
line{
	stroke:grey;
}
#play{
  position: absolute;
	margin-left: 52%;
	bottom: -15px;
	opacity: 0.6;
  cursor:pointer;
}
</style>
<body>
<script src="../scripts/d3.v4.js"></script>
<script src="../scripts/viz.js"></script>
<script src="../bootstrap/jquery-3.1.1.min.js"></script>
<script src="../noUiSlider.9.1.0/nouislider.js"></script>
<link rel="stylesheet" href="../noUiSlider.9.1.0/nouislider.css" />

<div id="sankey"></div>

<div class="section">
		<div id="year-slider" style="width: 50%; margin-left: 25%; margin-right: 25%;">
			<img id="play" width="40px" height="40px" src="images/play.png"/>
		</div>
</div>

<script>

var full_data = [];
var bp;
var g;
var slider_value = 1;
var playing = 0;

d3.csv("data/2001.csv", function(data) {
    data.forEach(function(d) {
        full_data.push([d['STATE/UT'], d['CAUSE'], d['TOTAL KILLED']])
    });

    stepSlider = document.getElementById('year-slider');

    noUiSlider.create(stepSlider, {
        start: [0],
        step: 1,
        range: {
            'min': [2001],
            'max': [2013]
        },
        pips: {
            mode: 'values',
            values: [2001, 2003, 2005, 2007, 2009, 2011, 2013],
            density: 8
        }
    });

    draw(full_data);
});

function draw(data) {
    var color = {
        "ANDHRA PRADESH": "#fdae61",
        "ARUNACHAL PRADESH": "#f89f5f",
        "ASSAM": "#f48f5d",
        "BIHAR": "#ef805b",
        "CHHATTISGARH": "#ea7159",
        "GOA": "#e86958",
        "GUJARAT": "#e66157",
        "HARYANA": "#e15255",
        'HIMACHAL PRADESH': "#dd5e5c",
        'JAMMU & KASHMIR': "#d47569",
        "JHARKHAND": "#ca8c76",
        "KARNATAKA": "#c1a383",
        "KERALA": "#b8ba90",
        "MADHYA PRADESH": "#b0d19d",
        "MAHARASHTRA": "#abdda4",
        "MANIPUR": "#a0d5a6",
        "MEGHALAYA": "#8bc7aa",
        "MIZORAM": "#76b7ad",
        "NAGALAND": '#60a8b1',
        'ODISHA': "#4b9ab4",
        "PUNJAB": '#368bb8',
        "RAJASTHAN": "#2b83ba",
        "SIKKIM": "#2778ab",
        "TAMIL NADU": "#20628b",
        "TRIPURA": "#194c6d",
        "UTTAR PRADESH": "#12374e",
        "UTTARAKHAND": "#0b212e",
        "WEST BENGAL": "#040b0f",
        "A & N ISLANDS": "#000000",
        "CHANDIGARH": "#151515",
        "D & N HAVELI": "#2b2b2b",
        "DAMAN & DIU": "#404040",
        "DELHI(UT)": "#555555",
        "LAKSHADWEEP": "#6a6a6a",
        "PUDUCHERRY": "#808080"
    };
    var width = 1200;
    var height = 650;
    var sankey_dimension = {
        width: 400,
        height: 575
    }

    var svg = d3.select("#sankey").append("svg").attr("width", width).attr("height", height);

    svg.append("foreignObject")
        .attr("width", 200)
        .attr("height", 30)
        .attr('x', width / 2 - 100)
        .attr('y', 10)
        .append("xhtml:body")
        .style("font", "14px 'Roboto Condensed', 'Helvetica', 'Arial', sans-serif")
        .html('<h4>Total Deaths - <span id="year-number">2001</span></h4>')

    bp = viz.bP()
        .data(data)
        .min(12)
        .pad(1)
        .height(sankey_dimension.height)
        .width(sankey_dimension.width)
        .barSize(35)
        .fill(d => color[d.primary]);

    g = svg.append("g").attr("transform", "translate(400,50)").call(bp);

    g.append("text").attr("x", -100).attr("y", -8).style("text-anchor", "middle").text("States").style("font-weight", 'normal').style('fill', '#808080').style("font", "'Roboto Condensed', 'Helvetica', 'Arial', sans-serif");
    g.append("text").attr("x", sankey_dimension.width + 100).attr("y", -8).style("text-anchor", "middle").text("Cause").style("font-weight", 'normal').style('fill', '#808080').style("font", "'Roboto Condensed', 'Helvetica', 'Arial', sans-serif");

    g.append("line").attr("x1", -100).attr("x2", 0);
    g.append("line").attr("x1", sankey_dimension.width).attr("x2", sankey_dimension.width + 100);
    g.append("text").attr("x", -5).attr("y", -8).style("text-anchor", "middle").text("%").style("font-weight", 'normal').style('fill', '#808080').style("font", "'Roboto Condensed', 'Helvetica', 'Arial', sans-serif");

    g.append("line").attr("y1", 620).attr("y2", 620).attr("x1", -100).attr("x2", 0);
    g.append("line").attr("y1", 620).attr("y2", 620).attr("x1", sankey_dimension.width).attr("x2", sankey_dimension.width + 100);
    g.append("text").attr("x", sankey_dimension.width + 5).attr("y", -8).style("text-anchor", "middle").text("%").style("font-weight", 'normal').style('fill', '#808080').style("font", "'Roboto Condensed', 'Helvetica', 'Arial', sans-serif");

    g.selectAll(".mainBars")
        .on("mouseover", mouseover);

    g.selectAll(".mainBars").append("text").attr("class", "label")
        .attr("x", d => (d.part == "primary" ? -90 : 90))
        .attr("y", d => +6)
				.style('fill', function(d){
					return d.part == "primary" ? color[d.key] : '#6a6a6a'
				}) // '#6a6a6a')
        .text(d => d.key)
				.style("font", "14px 'Roboto Condensed', 'Helvetica', 'Arial', sans-serif")
				.style('font-size', '12')
				.style('font-weight', 'normal')
        .attr("text-anchor", d => (d.part == "primary" ? "end" : "start"));

    g.selectAll(".mainBars").append("text").attr("class", "perc")
        .attr("x", d => (d.part == "primary" ? -22 : 22))
        .attr("y", d => +6)
        .text(function(d) {
            return parseInt((d.percent) * 100);
        })
        .style('fill', function(d){
					return d.part == "primary" ? color[d.key] : '#6a6a6a'
				}) // '#6a6a6a')
        .style("font-weight", 'normal')
        .style("font", "'Roboto Condensed', 'Helvetica', 'Arial', sans-serif")
        .attr("text-anchor", d => (d.part == "primary" ? "end" : "start"));

    g.selectAll(".mainBars").append("text").attr("class", "val")
        .attr("x", d => (d.part == "primary" ? -45 : 45))
        .attr("y", d => +6)
        .style("font-weight", 'normal')
        .text(function(d) {
            return d3.format("100")(d.value)
        })
        .style("font", "'Roboto Condensed', 'Helvetica', 'Arial', sans-serif")
				.style('fill', function(d){
					return d.part == "primary" ? color[d.key] : '#6a6a6a'
				}) // '#6a6a6a')
        .attr("text-anchor", d => (d.part == "primary" ? "end" : "start"));

    function mouseover(d) {
        g.selectAll(".mainBars").select(".perc")
            .text(function(d) {
                return parseInt((d.percent) * 100);
            });

        g.selectAll(".mainBars").select(".val")
            .text(function(d) {
                return d3.format("100")(d.value)
            });
    }

    stepSlider.noUiSlider.on('update', function(values, handle) {
        slider_value = parseInt(values);
        $('#year-number').html(slider_value);
        update_data(slider_value);
    });
}

function update_data(year) {

    d3.csv("data/" + year + ".csv", function(data) {
        for (i in full_data) {
            full_data[i][2] = data[i]['TOTAL KILLED'];
        }
        bp.update(full_data);

        g.selectAll(".mainBars").select(".perc")
            .text(function(d) {
                return parseInt((d.percent) * 100);
            });

        g.selectAll(".mainBars").select(".val")
            .text(function(d) {
                return d3.format("100")(d.value)
            });
    });

}

setInterval(function(){
	if (slider_value < 2014 && playing == 1 ) {
			stepSlider.noUiSlider.set(slider_value);
			slider_value = slider_value + 1;
	}
	if (slider_value == 2014) {
			playing = 2;
			document.getElementById("play").src = "images/reset.png";
	}
}, 500);

$(document).ready(function() {
    $('#play').click(function() {
        if (playing == 0) {
            playing = 1;
            document.getElementById("play").src = "images/pause.png";
        } else if (playing == 1) {
            playing = 0;
            document.getElementById("play").src = "images/play.png";
        } else if (playing == 2) {
            playing = 1;
            slider_value = 0;
						document.getElementById("play").src = "images/pause.png";
        }
    });
});

d3.select(self.frameElement).style("height", "800px");

</script>
</body>
</html>
